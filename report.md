
# Отчёт по проекту "Стилизация изображений в телеграм-боте"

Эту задачу я выбрала, потому что мне понравилась возможность получить какой-то реально работающий продукт.

Кроме того, своего бота для Телеграма я уже писала, но давно, поэтому хотелось освежить и эти знания.

## Описание этапов работы

Работу я выполняла примерно в том же порядке, в каком пункты были описаны в задании. Основное правило, которое я себе установила - получаем работающий результат и идём дальше; если будет время - возвращаемся и улучшаем.

### 1) Реализовать модель NST (любую), перенести функциональность в класс

Т.к. темы по переносу стиля с помощью нейросетей на базовом потоке не было, начала с просмотра уроков и по туториалу от PyTorch написала первую работающую модель в колабе (алгоритм Гатиса).

Получилась вот такая чудесная картинка, которую я затем использовала в приветственном сообщении бота.
![example image](https://github.com/lama-imp/dls_image_bot/blob/master/st_example.png)

Поскольку в колабе над ботом работать неудобно, решила переписать модель для локального запуска и использования в боте в класс.

Получился класс `StyleTransfer`, который принимает пути расположения изображений стиля и контента и выдаёт итоговый результат. Класс получился, честно признаю, довольно монструозный, далёкий от принципов SOLID, зато работающий.

(Забегая вперёд, скажу, что вообще я хотела потом попробовать и какой-нибудь другой алгоритм, например, в какой-то из статей алгоритм Ульянова выглядел интересно, но в итоговом варианте остался всё тот же Гатис.)

Переходим к следующему пункту

### 2) Написать бота

Предыдущего бота, о котором я упоминала, я писала с помощью `pyTelegramBotAPI`, поэтому в этот раз решила попробовать `aiogram`. Aiogram мне понравился намного больше, в нём куда больше возможностей.

Написала для начала эхо-бота, запустила - работает. Написала хэндлер для вызова класса `StyleTransfer` и обработки изображения.

На первых этапах я использовала в качестве стиля изображение, уже лежавшее у меня, от пользователя получая только контент.

Теперь осталось понять, как получить из сообщения пользователя изображение и что-то с ним сделать. Тут я не смогла придумать ничего лучше, чем сохранять изображение, добавив к нему айди пользователя, чтобы не путаться в разных пользователях.

Итак, теперь бот при получении изображения отправлял пользователю его стилизованную версию. Но нужно-то было стиль тоже получать от пользователя. Тут мне на помощь пришла FSM.

У бота появилось два состояния: `style` и `content`. При получении команды `/set_style` бот переходил в состояние `style`, сохранял следующее полученное изображение как стиль пользователя и переходил в состояние `content`. В состоянии `content` бот преобразовывает любое полученное от пользователя изображение в стилизованное под ранее заданный стиль.

Итак, бот работает и делает то, что нужно.

У следующих пунктов порядок выполнения был такой: 4-5-3-6

### 3) Асинхронность

На самом деле этот пункт я сделала практически последним.
Посмотрела несколько туториалов по асинхронности в программировании и по использованию `asyncio`. Вроде всё понятно и логично объясняют, но там функции, а у меня класс. На некоторое время отложила эту задачу.

Как сделать класс асинхронным, так и не поняла. В итоге асинхронность реализовала через костыль: написала функцию `style_transfer_func`, которая внутри себя создавала объект класса `StyleTransfer`, выполняла перенос стиля и сохраняла изображение, и написала асинхронную функцию, которая запускала функцию `style_transfer_func`:
```python
async def async_st(loop, style_transfer, *args):
    await loop.run_in_executor(None, style_transfer, *args)
```

В итоге вызов переноса стиля в боте стал выглядеть так:
```python
await async_st(loop, style_transfer_func, style_path, content_path, output_name)
```

Сработало - бот стал реагировать на команды от других пользователей в процессе переноса стиля и даже мог одновременно переносить два стиля.

### 4) Сделать интерфейс бота интуитивным и удобным

Расписала подробнее реакцию на команды `/start` и `/help`, добавила сообщения типа "Отправьте изображение, на которое хотите перенести стиль" и реакцию на прочие сообщения, не являюшиеся изображениями (тексты, эмодзи и т.п.)

### 5) Deploy бота на нужном сервисе

Самые главные мучения у меня вызвал этот пункт.

Началось всё с Heroku. Он бесплатный и вроде простой, решила я, по какому-то туториалу создала приложение на сайте, загрузила туда бота через GItHub, в первый раз, естественно, не прошло - torch занимает слишком много места, взяла другой wheel с их сайта - вроде загрузка прошла.

Не помню, если честно, пыталась ли я запустить бота через `polling` или сразу начала мучиться с вебхуками, которые у меня никак не получалось запустить. Пересмотрела примеры из документации aiogram, тонну туториалов - бот упорно не работал вообще. Наконец нашла работающий вариант параметров, запустила - ура, бот ответил на команду. Но радость была преждевременной - сам перенос стиля на Heroku запустить мне так и не удалось: превышение по памяти и SIGKILL.

Тогда по наводке сокурсника запустила бота на хостинге `ssd-vps.ru`. Там тоже всё происходило не без мучений, например, вебхуки подключить так и не удалось, потому что сайт не поддерживает https, потом бот то запускался, то не запускался, по пути я, кажется, сломала PyCharm у себя на компьютере. Наконец бота удалось запустить и вроде бы всё работало, но где-то через полдня начались странности - бот реагировал на команды и отправку изображений стиля, но не реагировал на отправку контента.

Пришлось запускать его на сервере в Докере, и теперь, кажется, всё в порядке - бот запущен двое суток назад, до сих пор работает и исправно отправляет стилизованные картинки.

### 6) Описать свою работу в достаточной степени подробно

Надеюсь, с этим заданием я справилась :)

### Дополнительная часть

А вот на это у меня времени уже не хватило, к сожалению... Посмотрела видео по GAN'ам, в целом принцип работы вроде понятен, но чтобы разобраться, как это работает в коде, времени не хватило, несмотря на продлённый дедлайн - в феврале начался большой рабочий проект и на учёбу выделить время не получится.

---
Всё равно было интересно и огромное спасибо за курс!
